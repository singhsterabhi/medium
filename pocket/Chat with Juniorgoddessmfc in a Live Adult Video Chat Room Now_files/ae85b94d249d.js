$(document).ready(function(){var slug_cache=[];var image_cache=[];var latest_slug='';var main=$('#main');main.after('<div id="autocomplete_prefix" style="display: none"></div><div id="emoticon_autocomplete" style="display: none"><div id="emoticon_preview"><a class="facebox_link thumbnail" href="#report_emoticon" rel="facebox"><input type="hidden" name="image_url" value="" /><input type="hidden" name="report_url" value="" /><img id="emoticon_image" src="" title="" /><br /><span id="preview_text">VIEW / REPORT EMOTICON</span></a></div><div id="emoticon_list"></div></div>');var chat_input=$('#chat_input');var emoticon_autocomplete=$('#emoticon_autocomplete');var emoticon_preview=$('#emoticon_preview');var emoticon_image=$('#emoticon_image');var emoticon_list=$('#emoticon_list');var prefix;var is_mouse_over_popup=false;var delay=parseInt(defchat_settings.emoticon_autocomplete_delay);var loading_image_url=$('#loading_image').attr('src');var list_vertical_padding=2;var max_visible_in_list=10;function get_emote_containers(){return $('.emote_container');}
function get_selected_container(){return $('.emote_container.selected');}
function highlightSuffix(){if(chat_input[0].setSelectionRange){chat_input[0].setSelectionRange(prefix.length+latest_slug.length+1,chat_input.val().length);}}
function deleteSuffix(){if(chat_input[0].selectionStart){chat_input.val(chat_input.val().substring(0,chat_input[0].selectionStart));}}
function wrapToBottom(){emoticon_autocomplete.children().last().children().last().addClass('selected');}
function wrapToTop(){emoticon_autocomplete.children().last().children().first().addClass('selected');}
function scrollEmotes(is_up){var previously_selected=get_selected_container();previously_selected.removeClass('selected');var newly_selected;if(is_up){newly_selected=previously_selected.prev();}else{newly_selected=previously_selected.next();}
newly_selected.addClass('selected');if(previously_selected.length==0){if(is_up){wrapToBottom();}else{wrapToTop();}}
if(is_up&&previously_selected.is(':first-child')){wrapToBottom();}
if(!(is_up)&&previously_selected.is(':last-child')){wrapToTop();}
newly_selected=get_selected_container();get_emote_containers().css('background-color','#fff');get_selected_container().css('background-color','#ccc');chat_input.val(chat_input.val().replace(new RegExp(previously_selected.find('.emote_name').text()+' $'),newly_selected.find('.emote_name').text()));var new_height=newly_selected.height()+(list_vertical_padding*2);var scroll_amount=newly_selected.index()*new_height-(new_height*max_visible_in_list/2);emoticon_list.scrollTop(scroll_amount);updatePreview();}
function updatePreview(){emoticon_image.attr('src','');emoticon_image.attr('src',loading_image_url);var new_src=$('.emote_container.selected > .img_src').val();var slug=$('.emote_container.selected > .emote_name').text();if($.inArray(new_src,image_cache)==-1){image_cache.push(new_src);}
emoticon_image.attr('src',new_src);emoticon_preview.find('input[name=image_url]').val(new_src.replace('_250x80',''));emoticon_preview.find('input[name=report_url]').val('/emoticon_report_abuse/'+slug+'/');emoticon_image.attr('title',':'+slug);get_emote_containers().css('background-color','#fff');get_selected_container().css('background-color','#ccc');updateInput();highlightSuffix();emoticon_preview.show();updatePosition();}
function updatePosition(){if(get_emote_containers().length==0){emoticon_autocomplete.hide();return;}
var char_offset=$('#autocomplete_prefix').text(prefix).width();emoticon_autocomplete.css({'top':chat_input.offset().top-emoticon_autocomplete.height()-8,'left':Math.min(chat_input.offset().left+char_offset+4,chat_input.parents('.chat-box').offset().left+chat_input.parents('.chat-box').width()-emoticon_autocomplete.width())});}
function updateInput(){var slug=$('.emote_container.selected > .emote_name').text();if(slug){var new_text=chat_input.val().replace(new RegExp(/:[\w-]{1,}$/),':'+slug);chat_input.val(new_text);chat_input.focus();}}
function hidePopup(){latest_slug='';emoticon_autocomplete.hide();}
function updateList(data){if(data['emoticons'].length>0){emoticon_list.html('');emoticon_preview.hide();for(var i=0;i<data['emoticons'].length;i++){if($.inArray(data['emoticons'][i]['slug'],defchat_settings.ignored_emoticons)==-1){emoticon_list.append('<div class="emote_container">\
                            <input type="hidden" class="img_src" value="'+data['emoticons'][i]['url']+'" />\
                            <span class="emote_name">'+data['emoticons'][i]['slug']+'</span>\
                        </div>');}}
var live_container=get_emote_containers();live_container.css({'padding':list_vertical_padding+'px 8px','background-color':'#fff'});$('.emote_name').css('margin-right','16px');if(delay==0||emoticon_autocomplete.is(':visible')){emoticon_autocomplete.show();}else{setTimeout(function(){emoticon_autocomplete.show();},parseInt(defchat_settings.emoticon_autocomplete_delay));}
emoticon_list.scrollTop($(document).height());updatePosition();}else{hidePopup();}}
emoticon_autocomplete.css({'background':'#fff','border':'1px solid #b1b1b1','border-bottom':'1px solid #fff','cursor':'pointer','float':'left','font':'100% Arial, Helvetica, sans-serif','width':'260px','max-height':'290px','position':'absolute','z-index':'99'});emoticon_preview.css({'height':'110px','line-height':'105px','text-align':'center','border-bottom':'1px solid #b1b1b1'});emoticon_image.css({'max-height':'80px','max-width':'250px','padding':'10px','vertical-align':'middle'});$('#preview_text').css({'font-size':'10px','position':'relative','top':'-55px'});emoticon_list.css({'max-height':'180px','overflow-x':'hidden','overflow-y':'scroll'});$('#autocomplete_prefix').css({'font':'100% Arial, Helvetica, sans-serif','width':'auto'});emoticon_autocomplete.live('mouseenter',function(){is_mouse_over_popup=true;});emoticon_autocomplete.live('mouseleave',function(){is_mouse_over_popup=false;});chat_input.live('keydown',function(e){if(emoticon_autocomplete.is(':visible')&&e.keyCode==13){hidePopup();}
if(emoticon_autocomplete.is(':visible')&&e.keyCode==38){e.preventDefault();scrollEmotes(true);}
if(emoticon_autocomplete.is(':visible')&&e.keyCode==40){e.preventDefault();scrollEmotes(false);}
if(emoticon_autocomplete.is(':visible')&&(e.keyCode==9||e.keyCode==39||e.keyCode==32)){e.preventDefault();updateInput();emoticon_autocomplete.hide();chat_input.val(chat_input.val()+' ');}
if(emoticon_autocomplete.is(':visible')&&(e.keyCode==27||e.keyCode==37)){e.preventDefault();emoticon_autocomplete.hide();deleteSuffix();}});get_emote_containers().live('click',function(){if($(this).hasClass('selected')){updateInput();chat_input.val(chat_input.val()+' ');hidePopup();}else{get_selected_container().removeClass('selected');$(this).addClass('selected');updatePreview();}});var noAjaxKeyCodes=[9,13,27,37,38,39,40];chat_input.live('keyup',function(e){delay=parseInt(defchat_settings.emoticon_autocomplete_delay);if(delay>=0&&$.inArray(e.keyCode,noAjaxKeyCodes)==-1){var match=$(this).val().match(/(^|.+\s):([\w-]{1,})$/);if(match){prefix=match[1]||'';latest_slug=match[2];if(latest_slug in slug_cache){updateList(slug_cache[latest_slug]);}else{$.ajax({url:'/get_emoticon_autocomplete/',data:{slug:latest_slug}}).success(function(data){if(data['slug']==latest_slug){slug_cache[latest_slug]=data;updateList(data);}});}}else{hidePopup();}}});$('a.close').live('mousedown',function(){setTimeout(function(){highlightSuffix();chat_input.focus();},100);});$('.report_abuse_link').live('mousedown',function(){if(emoticon_autocomplete.is(':visible')){setTimeout(function(){emoticon_autocomplete.hide();deleteSuffix();},100);}});$('#facebox').find('.content').find('img').live('mousedown',function(){if(emoticon_autocomplete.is(':visible')){$('a.close').click();setTimeout(function(){updateInput();chat_input.val(chat_input.val()+' ');hidePopup();chat_input.focus();},100);}});chat_input.focusout(function(){if(!(is_mouse_over_popup)&&!($('#facebox').is(':visible'))){hidePopup();}});});